<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBBS World - Interactive Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --accent: #06b6d4;
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-main: #1e293b;
            --text-light: #64748b;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- NAVIGATION --- */
        .navbar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            padding: 0.8rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--shadow-sm);
        }

        .nav-brand {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .search-container {
            flex: 1;
            max-width: 400px;
            margin: 0 2rem;
            position: relative;
        }

        .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 0.9rem;
            pointer-events: none;
        }

        .search-container input {
            width: 100%;
            padding: 0.6rem 1rem 0.6rem 2.5rem;
            border-radius: 50px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            font-size: 0.85rem;
            transition: 0.3s;
            outline: none;
        }

        .search-container input:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .main-nav {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-light);
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
            padding: 0.5rem 1rem;
            border-radius: 10px;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--primary);
            background: rgba(79, 70, 229, 0.1);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        /* --- UI ELEMENTS --- */
        .back-btn {
            position: relative;
            z-index: 1100;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.05);
            color: var(--text-main);
            padding: 0.6rem 1.2rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: var(--shadow-sm);
            margin-bottom: 5px;
        }

        .back-btn:hover {
            transform: translateX(-5px);
            background: white;
            border-color: var(--primary);
            color: var(--primary);
        }

        .back-btn i {
            font-size: 0.8rem;
        }

        .container {
            max-width: 1200px;
            margin: 1.5rem auto;
            padding: 0 1.5rem;
        }

        /* --- HOME VIEW (WELCOME) --- */
        .welcome-section {
            text-align: center;
            padding: 3rem 1rem;
            animation: fadeIn 0.8s ease;
        }

        .welcome-section h1 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .welcome-section p {
            color: var(--text-light);
            font-size: 1.1rem;
            margin-bottom: 3rem;
        }

        .portal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 2rem;
        }

        .portal-card {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: var(--shadow-md);
        }

        .portal-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .portal-card i {
            font-size: 3.5rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: block;
        }

        .portal-card h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .portal-card p {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        /* --- SUBJECT TABS (Dynamic) --- */
        .subject-tabs {
            display: none;
            gap: 0.8rem;
            padding-bottom: 1.5rem;
        }

        .subject-tabs.visible {
            display: flex;
            flex-direction: column;
            max-width: 600px;
            margin: 0 auto;
        }

        .subject-tab {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            color: var(--text-light);
            font-weight: 500;
            transition: 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .subject-tab::after {
            content: '\f105';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            opacity: 0.5;
        }

        .subject-tab.active {
            background: var(--primary);
            color: white;
            border-color: transparent;
        }

        .subject-tab.active::after {
            opacity: 1;
        }

        /* --- CONTENT RENDERERS --- */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem;
            margin-top: 1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: var(--shadow-md);
            transition: 0.3s;
            position: relative;
            /* Fixed: Added relative for absolute children */
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .section-title {
            grid-column: 1 / -1;
            font-size: 1.2rem;
            font-weight: 700;
            margin: 1.5rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Video Elements */
        .video-wrapper {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }

        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .chapter-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .chapter-card {
            background: white;
            padding: 1.2rem;
            border-radius: 15px;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .chapter-card:hover {
            transform: translateX(10px);
            color: var(--primary);
            border-color: var(--primary);
        }

        .chapter-icon {
            width: 40px;
            height: 40px;
            background: rgba(79, 70, 229, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .back-btn {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
            display: inline-block;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        .glass-shield {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            /* Lowered z-index */
            background: transparent;
        }

        .timeline-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timeline {
            flex-grow: 1;
            height: 5px;
            cursor: pointer;
        }

        .time-display {
            font-size: 0.7rem;
            color: var(--text-light);
            min-width: 80px;
            text-align: center;
        }

        .custom-controls {
            position: absolute;
            bottom: 70px;
            /* Adjusted to float over video in portrait */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 450px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            padding: 8px 15px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 5px;
            transition: 0.3s;
        }

        .buttons-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 2px 0;
        }

        .ctrl-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            background: #f3f4f6;
            color: #4b5563;
        }

        .ctrl-btn.primary {
            background: var(--primary);
            color: white;
            width: 38px;
            height: 38px;
            font-size: 1rem;
        }

        .ctrl-btn:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }

        .speed-row {
            display: flex;
            gap: 4px;
            justify-content: center;
            flex-wrap: nowrap;
        }

        .speed-btn {
            padding: 4px 6px;
            font-size: 0.7rem;
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: 500;
            white-space: nowrap;
        }

        .speed-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .speed-btn:hover:not(.active) {
            background: #e5e7eb;
        }

        /* File Elements */
        .file-btn:hover {
            background: var(--primary);
        }

        /* --- ADVANCED VIDEO CONTROLS --- */
        .video-wrapper {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%;
            /* 16:9 Aspect Ratio */
            background: #000;
            overflow: hidden;
            border-radius: 8px 8px 0 0;
            touch-action: manipulation;
        }

        .video-wrapper iframe,
        .video-wrapper object,
        .video-wrapper embed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .tap-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 70px);
            /* Leave room for floating toolbar */
            z-index: 2;
            cursor: pointer;
            display: flex;
        }

        .tap-side {
            width: 50%;
            height: 100%;
            position: relative;
        }

        /* Seek Feedback Animation */
        .seek-feedback {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        .seek-left {
            left: 10%;
        }

        .seek-right {
            right: 10%;
        }

        .seek-feedback.active {
            opacity: 1;
            transform: translateY(-50%) scale(1.2);
        }

        /* Landscape/Fullscreen Overlay */
        .video-controls-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
            z-index: 10000;
            display: none;
            align-items: center;
            padding: 0 1rem;
            justify-content: space-between;
            color: white;
        }

        .video-controls-overlay.visible {
            display: flex;
        }

        .overlay-back {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .speed-row-overlay {
            display: flex;
            gap: 10px;
        }

        /* LANDSCAPE SPECIFIC */
        @media (orientation: landscape) {
            .video-wrapper {
                max-height: 80vh !important;
                padding-bottom: 0 !important;
                height: 80vh !important;
            }

            .custom-controls {
                bottom: 5px !important;
                /* Move to bottom of card overlaying title */
                width: 95%;
                padding: 5px 15px;
                max-width: none;
            }

            .video-controls-overlay {
                height: 50px;
            }

            .speed-btn {
                padding: 2px 6px;
                font-size: 0.7rem;
            }
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            width: 100%;
            height: 100%;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #ef4444;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-modal {
            position: absolute;
            top: 1rem;
            right: 4rem;
            background: var(--primary);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pdf-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 50;
            pointer-events: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- QUIZ INTELLIGENCE STYLES --- */
        .quiz-filter-bar {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0 20px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .quiz-filter-bar::-webkit-scrollbar {
            display: none;
        }

        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(79, 70, 229, 0.2);
            background: white;
            color: var(--text-light);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.3s;
            white-space: nowrap;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }

        .platform-badge {
            background: rgba(109, 40, 217, 0.1);
            color: #7c3aed;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
            border: 1px solid rgba(109, 40, 217, 0.2);
        }

        .subject-badge {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 8px;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .chapter-card .quiz-type-icon {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-right: 5px;
        }

        .premium-lock {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #fbbf24;
            font-size: 0.9rem;
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.2));
        }

        .modal-footer {
            position: absolute;
            bottom: 0px;
            left: 0;
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 101;
        }

        .external-link-btn {
            background: var(--primary);
            color: white;
            padding: 6px 15px;
            border-radius: 50px;
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2);
        }

        .external-link-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .chapter-card.is-premium {
            border: 1px solid rgba(251, 191, 36, 0.2);
            background: linear-gradient(to right, white, rgba(251, 191, 36, 0.05));
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- MOBILE RESPONSIVENESS FIXES --- */
        @media (max-width: 768px) {
            .navbar {
                padding: 0.8rem;
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }

            .nav-brand {
                font-size: 1.1rem;
                width: 100%;
                justify-content: center;
                margin-bottom: 5px;
            }

            .main-nav {
                width: 100%;
                overflow-x: auto;
                justify-content: flex-start;
                padding: 5px 0;
                scrollbar-width: none;
                -ms-overflow-style: none;
                gap: 5px;
            }

            .main-nav::-webkit-scrollbar {
                display: none;
            }

            .nav-link {
                font-size: 0.75rem;
                padding: 0.5rem 0.8rem;
                white-space: nowrap;
            }

            .user-menu {
                width: 100%;
                justify-content: center;
                padding-top: 5px;
                border-top: 1px solid rgba(0, 0, 0, 0.05);
            }

            .welcome-section {
                padding: 1.5rem 0.5rem;
            }

            .welcome-section h1 {
                font-size: 1.6rem;
            }

            .welcome-section p {
                font-size: 0.9rem;
                margin-bottom: 1.5rem;
            }

            .portal-grid {
                gap: 1rem;
                grid-template-columns: 1fr;
            }

            .portal-card {
                padding: 1.5rem;
            }

            .container {
                padding: 0 1rem;
                margin-top: 1rem;
            }

            .back-btn {
                margin: 0.5rem 0 1rem 0;
                width: 100%;
                justify-content: center;
            }

            .section-title {
                font-size: 1rem;
            }

            .chapter-card {
                padding: 1rem;
                gap: 10px;
                font-size: 0.9rem;
            }

            .chapter-icon {
                width: 35px;
                height: 35px;
            }
        }

        @media (max-width: 480px) {
            .portal-card i {
                font-size: 2.5rem;
                margin-bottom: 1rem;
            }

            .portal-card h3 {
                font-size: 1.1rem;
            }

            .modal {
                padding: 0.5rem;
            }

            .close-modal {
                top: 0.5rem;
                right: 0.5rem;
                width: 30px;
                height: 30px;
            }
        }

        .subject-sidebar {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            max-width: 400px;
            margin: 0 auto;
            max-height: 60vh;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        .subject-sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .subject-sidebar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .subject-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #333;
            text-transform: capitalize;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .subject-item:hover,
        .subject-item.active {
            background: var(--primary);
            color: white;
            transform: translateX(5px);
            border-color: transparent;
        }

        .subject-item::after {
            content: '\f105';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 1.2rem;
            opacity: 0.6;
        }

        /* --- LOGIN UI --- */
        #login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 2rem;
            text-align: center;
        }

        .login-box {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            padding: 3rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.5);
            max-width: 400px;
            width: 100%;
        }

        .login-box h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .login-box input {
            width: 100%;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            font-size: 1rem;
            outline: none;
            transition: 0.3s;
        }

        .login-box input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .login-box button {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }

        .login-box button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        #error-msg {
            margin-top: 1rem;
            font-size: 0.85rem;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div id="login-container">
        <div class="login-box">
            <i class="fas fa-user-lock" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <h2>MBBS World Access</h2>
            <input type="text" id="loginUserName" placeholder="Enter Your Full Name">
            <button onclick="checkAccess()">Enter Website</button>
            <p id="error-msg" style="color:#ef4444;"></p>
        </div>
    </div>

    <div id="main-content" style="display:none;">
        <div id="landscapeOverlay" class="video-controls-overlay">
            <button class="overlay-back" onclick="exitLandscape()"><i class="fas fa-arrow-left"></i> Back</button>
            <div class="speed-row-overlay" id="overlaySpeedRow">
                <!-- Dynamic Speed Buttons -->
            </div>
        </div>

        <nav class="navbar">
            <div class="nav-brand" onclick="navigate('home')"><i class="fas fa-heartbeat" style="color:#ef4444"></i>
                MBBS
                World</div>
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="globalSearch" placeholder="Search subjects or topics..."
                    oninput="handleSearch()">
            </div>
            <div class="main-nav">
                <a href="#" class="nav-link" id="nav-home" onclick="navigate('home')"><i class="fas fa-home"></i>
                    Home</a>
                <a href="#" class="nav-link" id="nav-videos" onclick="navigate('videos')"><i
                        class="fas fa-play-circle"></i>
                    Videos</a>
                <a href="#" class="nav-link" id="nav-notes" onclick="navigate('notes')"><i class="fas fa-file-pdf"></i>
                    Notes</a>
                <a href="#" class="nav-link" id="nav-quizzes" onclick="navigate('quizzes')"><i
                        class="fas fa-lightbulb"></i>
                    Quizzes</a>
                <a href="#" class="nav-link" id="nav-qbank" onclick="navigate('qbank')"><i class="fas fa-tasks"></i>
                    Q-Bank</a>
            </div>
            <div class="user-menu">
                <span id="userName" style="font-weight:600; font-size:0.9rem"></span>
                <button onclick="handleLogout()" class="logout-btn">Logout</button>
            </div>
        </nav>

        <div class="container">
            <!-- Main Content Area -->
            <div id="contentArea">
                <!-- Home View (Default) -->
                <div class="welcome-section">
                    <h1>Welcome, <span id="welcomeName">Student</span>!</h1>
                    <p>What would you like to study today?</p>
                    <div class="portal-grid">
                        <div class="portal-card" onclick="navigate('videos')"><i class="fas fa-video"></i>
                            <h3>Video Lectures</h3>
                            <p>Premium video content with summary notes.</p>
                        </div>
                        <div class="portal-card" onclick="navigate('notes')"><i class="fas fa-book"></i>
                            <h3>Notes PDF</h3>
                            <p>Standard textbook reference material.</p>
                        </div>
                        <div class="portal-card" onclick="navigate('qbank')"><i class="fas fa-graduation-cap"></i>
                            <h3>Question Bank</h3>
                            <p>Test your knowledge with practice files.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fileModal" class="modal">
            <div class="modal-content">
                <div id="pdfLoader" class="pdf-loader">
                    <div class="spinner"></div>
                    <p style="color: white; font-size: 0.8rem; opacity: 0.7;">Launching Viewer...</p>
                </div>
                <button class="fullscreen-modal" onclick="togglePdfFullScreen()" title="Toggle Full Screen">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="close-modal" onclick="closeModal()" title="Close">
                    <i class="fas fa-times"></i>
                </button>
                <div id="modalFooter" class="modal-footer">
                    <a id="externalLink" href="#" target="_blank" class="external-link-btn">
                        <i class="fas fa-external-link-alt"></i> Open in New Tab
                    </a>
                </div>
                <iframe id="fileViewer" style="width:100%; height:calc(100% - 45px); border:none;" src=""
                    allow="autoplay"
                    sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-presentation allow-popups-to-escape-sandbox allow-top-navigation-by-user-activation allow-modals"
                    onload="document.getElementById('pdfLoader').style.display='none'; this.focus();"></iframe>
            </div>
        </div>

        <script src="https://www.youtube.com/iframe_api"></script>

        <script>
            // --- DATA ENGINE ---
            let allData = []; // Global raw data
            let mbbsData = {}; // Structured data
            const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSC_oD0BX4WhhLDL6e6WybIEXmvbiroBMBiGASJ2r-HdxlIOmDFqaWpUEMdDydPUHVOQNsOGGbgJR6O/pub?output=csv";

            const MBBS_SUBJECTS = [
                "Anatomy", "Physiology", "Biochemistry",
                "Pharmacology", "Pathology", "Microbiology",
                "Forensic Medicine", "Community Medicine",
                "Medicine", "Surgery", "OBGY", "Pediatrics",
                "ENT", "Ophthalmology", "Orthopedics",
                "Dermatology", "Psychiatry", "Radiology", "Anaesthesia"
            ];

            async function fetchSheetData() {
                try {
                    const response = await fetch(SHEET_URL);
                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                    let text = await response.text();

                    // Remove Byte Order Mark (BOM) if present
                    text = text.replace(/^\uFEFF/, '');

                    // If it looks like HTML (Google login page or error), it's not a published CSV
                    if (text.includes('<!DOCTYPE html>') || text.includes('<html>')) {
                        throw new Error("Invalid CSV format. Please ensure your Google Sheet is 'Published to the Web' as a CSV.");
                    }

                    console.log("Sheet data fetched successfully");
                    const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
                    if (lines.length < 2) throw new Error("Spreadsheet is empty or has no data rows.");

                    allData = lines.slice(1);
                    mbbsData = {};
                    allData.forEach(line => {
                        const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                        if (cols.length < 4) return;

                        // Consistent Mapping from Google Sheet (Column A=Subj, B=Type, C=Title, D=Link, E=Platform)
                        const subjRaw = cols[0] || 'Other';
                        const typeRaw = cols[1] || '';
                        const titleRaw = cols[2] || 'Untitled';
                        const linkRaw = cols[3] || '';
                        const platformRaw = cols[4] || 'Other';

                        const isPremium = subjRaw.toLowerCase() === "other" || !subjRaw;
                        const cleanSubject = isPremium ? "Premium" : subjRaw;
                        const subKey = isPremium ? "premium" : cleanSubject.toLowerCase().trim().replace(/ /g, '_');

                        const typeKey = typeRaw.toLowerCase().trim();

                        if (!mbbsData[subKey]) {
                            mbbsData[subKey] = { videos: [], keyPoints: [], notes: [], qbank: [], quizzes: [] };
                        }

                        // Standardize object structure
                        const item = {
                            Subject: subjRaw, // Using user requested property name
                            title: titleRaw,
                            link: linkRaw,
                            platform: platformRaw,
                            Type: typeKey, // Standardizing on capital Type
                            subjectName: cleanSubject,
                            isPremium
                        };

                        if (typeKey === 'videos' || typeKey === 'video') {
                            const vidId = getYoutubeVideoId(linkRaw);
                            mbbsData[subKey].videos.push({ ...item, link: vidId });
                        } else if (typeKey === 'notes') {
                            mbbsData[subKey].notes.push(item);
                        } else if (typeKey === 'qbank') {
                            mbbsData[subKey].qbank.push(item);
                        } else if (typeKey.includes('quiz')) {
                            mbbsData[subKey].quizzes.push(item);
                        } else if (typeKey === 'keypoints' || typeKey === 'keypoint') {
                            mbbsData[subKey].keyPoints.push({ ...item, content: linkRaw });
                        }
                    });

                    // Set initial UI
                    showMainMenu();

                } catch (e) {
                    console.error("CSV Fetch Error:", e);
                    document.getElementById('contentArea').innerHTML = `
                    <div style="text-align:center; padding:5rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size:3rem; color:#ef4444; margin-bottom:1rem;"></i>
                        <h2 style="color:#ef4444; margin-bottom:0.5rem;">Data Load Failure</h2>
                        <p style="color:var(--text-light); max-width:500px; margin:0 auto;">${e.message}</p>
                        <div style="margin-top:2rem; font-size:0.9rem; color:var(--text-light)">
                            <p>Please ensure your Google Sheet is <b>Published to the Web</b>:</p>
                            <p>File -> Share -> Publish to the Web -> Link -> <b>CSV</b></p>
                        </div>
                    </div>
                `;
                }
            }

            function getYoutubeVideoId(url) {
                if (!url) return "";
                url = url.trim();
                if (url.length === 11 && !url.includes('.') && !url.includes('/')) return url;
                // Regex to strictly capture only 11 characters after any of the YouTube URL prefixes
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=|shorts\/|live\/)([^#\&\?]{11}).*/;
                const match = url.match(regExp);
                const id = (match && match[2].length === 11) ? match[2] : url;
                return id;
            }

            let currentView = 'home';
            let currentSubject = null;
            let currentPlatform = null;
            let selectedChapterIdx = null;
            let currentQuizFilter = 'all';
            let players = {};
            let pendingPlayers = [];
            let navHistory = [];

            function pushNavState() {
                navHistory.push({
                    view: currentView,
                    subject: currentSubject,
                    platform: currentPlatform,
                    chapterIdx: selectedChapterIdx,
                    quizFilter: currentQuizFilter,
                    scrollPos: window.scrollY
                });
            }

            window.goBack = () => {
                if (navHistory.length === 0) {
                    showMainMenu();
                    return;
                }

                // --- Bandwidth & Performance Fix: Clear background iframes ---
                cleanupIframes();

                const prevState = navHistory.pop();
                currentView = prevState.view;
                currentSubject = prevState.subject;
                currentPlatform = prevState.platform;
                selectedChapterIdx = prevState.chapterIdx;
                currentQuizFilter = prevState.quizFilter;

                // Re-render based on restored state
                if (currentView === 'home') {
                    showMainMenu(true);
                } else if (currentView === 'qbank' && !currentPlatform) {
                    filterCategory('qbank', true);
                } else {
                    renderContent(true);
                }

                // Restore scroll position after rendering
                setTimeout(() => {
                    window.scrollTo({ top: prevState.scrollPos, behavior: 'auto' });
                }, 100);
            };

            function cleanupIframes() {
                // Stop any playing YouTube videos
                Object.values(players).forEach(p => {
                    if (p && p.stopVideo) p.stopVideo();
                    if (p && p.destroy) p.destroy();
                });
                players = {};
                pendingPlayers = [];
                window.activePlayerId = null;

                // Clear Quiz/PDF Iframe definately
                const viewer = document.getElementById('fileViewer');
                if (viewer) {
                    viewer.src = '';
                    viewer.removeAttribute('srcdoc');
                }

                // Close modal if open
                const modal = document.getElementById('fileModal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            }

            function handleSearch() {
                const query = document.getElementById('globalSearch').value.toLowerCase().trim();

                if (currentSubject) {
                    // If a subject is selected, we filter the items inside that subject
                    renderItems(query);
                } else if (currentView === 'home') {
                    // Home search logic can be added here if needed
                } else {
                    // Filter the subject list
                    renderSubjectList(query);
                }
            }

            // UI State Controllers
            window.checkAccess = () => {
                const nameInput = document.getElementById('loginUserName');
                const name = nameInput.value.trim();
                if (!name) {
                    document.getElementById('error-msg').innerText = "Please enter your name.";
                    return;
                }

                const scriptURL = "https://script.google.com/macros/s/AKfycbyKKtYO8z3gBk1GiOHSMX8DJV7CikXupAP8sYLRoxASPFBUslRtHIQFoYsqy9ie_v6clQ/exec";
                const errorEl = document.getElementById('error-msg');
                errorEl.innerText = "Authenticating...";
                errorEl.style.color = "var(--primary)";

                fetch(`${scriptURL}?name=${encodeURIComponent(name)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.allowed) {
                            localStorage.setItem('mbbs_user', name);
                            document.getElementById('login-container').style.display = 'none';
                            document.getElementById('main-content').style.display = 'block';

                            const firstName = name.split(' ')[0] || "Student";
                            window.userSessionName = firstName;
                            document.getElementById('userName').innerText = name;

                            const mainWelcome = document.getElementById('welcomeName');
                            if (mainWelcome) mainWelcome.innerText = firstName;
                            const homeWelcome = document.getElementById('welcomeNameHome');
                            if (homeWelcome) homeWelcome.innerText = firstName;

                            fetchSheetData();
                        } else {
                            errorEl.innerText = data.message || "Invalid name or access expired.";
                            errorEl.style.color = "#ef4444";
                        }
                    })
                    .catch(error => {
                        console.error('Auth Error!', error.message);
                        errorEl.innerText = "Unable to connect. Checking offline access...";
                        if (localStorage.getItem('mbbs_user') === name) {
                            // Fallback if network fails but they were logged in before
                            document.getElementById('login-container').style.display = 'none';
                            document.getElementById('main-content').style.display = 'block';
                            fetchSheetData();
                        } else {
                            errorEl.innerText = "Connection error. Please check your internet.";
                        }
                    });
            };

            window.logStudentActivity = (subject, title) => {
                const userName = localStorage.getItem('mbbs_user');
                const scriptURL = "https://script.google.com/macros/s/AKfycbyKKtYO8z3gBk1GiOHSMX8DJV7CikXupAP8sYLRoxASPFBUslRtHIQFoYsqy9ie_v6clQ/exec";

                if (!userName || !subject || !title) return;

                console.log(`Logging activity: ${userName} - ${subject} - ${title}`);
                fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors', // Standard for simple Apps Script POSTS
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userName, subject, title })
                }).catch(e => console.error("Logging failed:", e));
            };

            window.handleLogout = () => {
                localStorage.removeItem('mbbs_user');
                window.location.reload();
            };

            window.showMainMenu = (isBack = false) => {
                if (!isBack) pushNavState();
                currentView = 'home';
                currentSubject = null;
                currentPlatform = null;
                selectedChapterIdx = null;
                window.activePlayerId = null;
                updateOrientation();
                updateNavActive('home');
                renderHome();
            };

            window.filterCategory = (type, isBack = false) => {
                if (!isBack) pushNavState();
                currentView = type;
                currentPlatform = null;
                currentSubject = null;
                selectedChapterIdx = null;
                currentQuizFilter = 'all';
                window.activePlayerId = null;
                updateOrientation();
                updateNavActive(type);

                if (type === 'qbank') {
                    renderPlatforms();
                } else {
                    renderSubjectList();
                }
            };

            function renderPlatforms() {
                const area = document.getElementById('contentArea');
                const platforms = new Set();

                Object.values(mbbsData).forEach(subj => {
                    subj.qbank.forEach(item => {
                        if (item.platform) platforms.add(item.platform);
                    });
                });

                const platformList = Array.from(platforms).sort();

                area.innerHTML = `
                <div class="welcome-section" style="padding: 1rem 0;">
                    <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i> Back</button>
                    <h1><i class="fas fa-layer-group"></i> Select Platform</h1>
                    <p>Choose a Question Bank provider</p>
                </div>
                <div class="portal-grid" style="margin-top:1rem;">
                    ${platformList.map(p => `
                        <div class="portal-card" onclick="setPlatform('${p}')">
                            <i class="fas fa-university"></i>
                            <h3>${p}</h3>
                            <p>Browse content from ${p}</p>
                        </div>
                    `).join('')}
                </div>
            `;

                if (platformList.length === 0) {
                    area.innerHTML += `<div style="text-align:center; padding:2rem; color:var(--text-light)">No platforms found in Question Bank.</div>`;
                }
            }

            window.setPlatform = (platform) => {
                pushNavState();
                currentPlatform = platform;
                renderSubjectList();
            };

            function updateNavActive(view) {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                const activeLink = document.getElementById(`nav-${view}`);
                if (activeLink) activeLink.classList.add('active');
            }

            // window.onload ensures data is ready before clicks
            window.onload = () => {
                const savedUser = localStorage.getItem('mbbs_user');
                if (savedUser) {
                    document.getElementById('loginUserName').value = savedUser;
                    checkAccess();
                }

                // Add Enter key listener
                const loginInput = document.getElementById('loginUserName');
                if (loginInput) {
                    loginInput.addEventListener('keyup', (e) => {
                        if (e.key === 'Enter') checkAccess();
                    });
                }
            };

            window.navigate = (view) => {
                if (view === 'home') showMainMenu();
                else filterCategory(view);
            };

            function renderSubjectList(searchQuery = '') {
                const area = document.getElementById('contentArea');
                const cleanQuery = searchQuery.toLowerCase().trim();

                // Filter subjects that actually have content for the current view and platform
                const filteredSubjects = Object.keys(mbbsData).filter(subj => {
                    const data = mbbsData[subj];
                    const matchesSearch = subj.replace(/_/g, ' ').toLowerCase().includes(cleanQuery);
                    if (!matchesSearch) return false;

                    if (currentView === 'videos') return data.videos && data.videos.length > 0;
                    if (currentView === 'notes') return data.notes && data.notes.length > 0;
                    if (currentView === 'quizzes') return data.quizzes && data.quizzes.length > 0;
                    if (currentView === 'qbank') {
                        const hasClassic = data.qbank && data.qbank.some(item => item.platform === currentPlatform);
                        return hasClassic;
                    }
                    return false;
                });

                area.innerHTML = `
                <div class="welcome-section" style="padding: 1rem 0;">
                    <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i> Back</button>
                    <h1><i class="fas ${getViewIcon()}"></i> Select Subject</h1>
                    <p>Browsing ${currentView.toUpperCase()} ${currentPlatform ? `(${currentPlatform})` : ''}</p>
                </div>
                <div class="subject-sidebar">
                    ${filteredSubjects.map(subj => {
                    const name = subj.replace(/_/g, ' ').toUpperCase();
                    return `
                            <div class="subject-item" onclick="setSubject('${subj}')">
                                <span>${name}</span>
                            </div>`;
                }).join('')}
                </div>
            `;

                if (filteredSubjects.length === 0) {
                    area.innerHTML += `<div style="text-align:center; padding:2rem; color:var(--text-light)">No subjects matching "${searchQuery}" found.</div>`;
                }
            }

            function getViewIcon() {
                if (currentView === 'videos') return 'fa-play-circle';
                if (currentView === 'notes') return 'fa-file-pdf';
                if (currentView === 'quizzes') return 'fa-lightbulb';
                if (currentView === 'qbank') return 'fa-tasks';
                return 'fa-folder';
            }

            function setSubject(subjectName) {
                pushNavState();

                if (!subjectName || subjectName.toLowerCase() === 'premium') {
                    currentSubject = 'premium';
                } else {
                    // Normalize for key-based lookup in mbbsData
                    // This aligns with item.Subject.toLowerCase() === subjectName.toLowerCase() logic
                    currentSubject = subjectName.toLowerCase().trim().replace(/ /g, '_');
                }

                selectedChapterIdx = null;
                renderContent();
            }

            function renderHome() {
                document.getElementById('contentArea').innerHTML = `
                <div class="welcome-section">
                    <h1>Welcome Back, <span id="welcomeNameHome">${window.userSessionName || 'Student'}</span>!</h1>
                    <p>What would you like to study today?</p>
                    <div class="portal-grid">
                        <div class="portal-card" onclick="filterCategory('videos')">
                            <i class="fas fa-video"></i>
                            <h3> Video Lectures</h3>
                            <p>Premium medical video content.</p>
                        </div>
                        <div class="portal-card" onclick="filterCategory('notes')">
                            <i class="fas fa-book"></i>
                            <h3> Study Notes</h3>
                            <p>Standard textbook reference PDFs.</p>
                        </div>
                        <div class="portal-card" onclick="filterCategory('quizzes')">
                            <i class="fas fa-lightbulb"></i>
                            <h3> Specialized Quizzes</h3>
                            <p>Interactive HTML medical quizzes.</p>
                        </div>
                        <div class="portal-card" onclick="filterCategory('qbank')">
                            <i class="fas fa-graduation-cap"></i>
                            <h3> Question Bank</h3>
                            <p>Test your knowledge with MCQs.</p>
                        </div>
                    </div>
                </div>
            `;
            }

            function renderContent(isBack = false) {
                const area = document.getElementById('contentArea');
                area.innerHTML = '';

                // --- Bandwidth & Performance Fix: Definitive Cleanup on every view change ---
                cleanupIframes();
                updateOrientation();

                // Header Section
                const header = document.createElement('div');
                header.innerHTML = `
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 1.5rem;">
                    <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i> Back</button>
                    <h1 style="margin:0; font-size:1.5rem;"><i class="fas ${getViewIcon()}"></i> ${currentView.toUpperCase()}</h1>
                </div>
            `;
                area.appendChild(header);

                if (currentView === 'videos') {
                    // --- VIDEOS LOGIC (Subject Grid First) ---
                    if (!currentSubject) {
                        renderSubjectList();
                        return;
                    }

                    const data = mbbsData[currentSubject];
                    if (selectedChapterIdx === null) {
                        // Show Chapter List
                        const list = document.createElement('div');
                        list.className = 'chapter-list';
                        data.videos.forEach((v, idx) => {
                            const vidId = v.link;
                            const isDone = localStorage.getItem('completed_' + vidId) === 'true';
                            const item = document.createElement('div');
                            item.className = 'chapter-card';
                            if (isDone) item.style.borderLeft = "4px solid #10b981";
                            item.onclick = () => {
                                logStudentActivity(v.Subject || currentSubject, v.title);
                                pushNavState();
                                selectedChapterIdx = idx;
                                renderContent();
                            };
                            item.innerHTML = `
                            <div class="chapter-icon" style="${isDone ? 'background:rgba(16, 185, 129, 0.1); color:#10b981;' : ''}">
                                <i class="fas ${isDone ? 'fa-check-circle' : 'fa-play'}"></i>
                            </div>
                            <div style="flex-grow:1; font-weight:500;">
                                Chapter ${idx + 1}: ${v.title}
                            </div>
                            <i class="fas fa-circle-play" style="color:${isDone ? '#10b981' : 'var(--primary)'}; font-size:1.2rem;"></i>
                        `;
                            list.appendChild(item);
                        });
                        area.appendChild(list);
                    } else {
                        renderVideoCard(area, data.videos[selectedChapterIdx], selectedChapterIdx);
                    }
                } else if (currentView === 'notes' || currentView === 'quizzes') {
                    // --- Permanent List View Level ---
                    if (!currentSubject) {
                        renderSubjectList();
                        return;
                    }

                    const list = document.createElement('div');
                    list.className = 'chapter-list';
                    list.id = 'quiz-list-container';
                    area.appendChild(list);

                    renderItems();
                } else if (currentView === 'qbank') {
                    // Keep legacy QBank Platform selection for now
                    if (!currentPlatform) {
                        renderPlatforms();
                    } else if (!currentSubject) {
                        renderSubjectList();
                    } else {
                        // Subject is selected, show the QBank items
                        const list = document.createElement('div');
                        list.className = 'chapter-list';
                        list.id = 'quiz-list-container';
                        area.appendChild(list);

                        renderItems();
                    }
                }
                if (area.innerHTML === '') {
                    area.innerHTML = `
                    <div style="text-align:center; padding:5rem; color:var(--text-light)">
                        <i class="fas fa-search" style="font-size:3rem; opacity:0.1; margin-bottom:1rem;"></i>
                        <p>No content available for this subject yet.<br><span style="font-size:0.9rem; color:var(--primary)"> Try checking the Premium section!</span></p>
                    </div>
                `;
                }
            }

            function renderItems(searchQuery = '') {
                const container = document.getElementById('quiz-list-container');
                if (!container) return;
                container.innerHTML = '';

                const data = mbbsData[currentSubject];
                if (!data) {
                    container.innerHTML = `<div style="text-align:center; padding:3.5rem; color:var(--text-light)">Subject data not found for "${currentSubject}".</div>`;
                    return;
                }

                let items = [];
                if (currentView === 'notes') {
                    items = data.notes;
                } else if (currentView === 'quizzes') {
                    items = data.quizzes;
                } else if (currentView === 'qbank') {
                    // Strict Filtering: Only show items explicitly marked as 'qbank' in Column B
                    // Ensure platform matching is also respected
                    items = data.qbank.filter(i => i.platform === currentPlatform && i.Type === 'qbank');
                }

                // Apply search filtering
                if (searchQuery) {
                    items = items.filter(i => i.title.toLowerCase().includes(searchQuery.toLowerCase()));
                }

                items.forEach((item, idx) => {
                    const card = document.createElement('div');
                    card.className = `chapter-card ${item.isPremium ? 'is-premium' : ''}`;

                    const isQuiz = item.Type && item.Type.includes('quiz');
                    card.onclick = () => {
                        logStudentActivity(item.Subject || currentSubject, item.title);
                        if (item.isPremium) {
                            alert(" This high-value content is exclusive for Premium Members! Launching viewer...");
                        }
                        isQuiz ? openQuiz(item.link) : openFile(item.link);
                    };

                    const icon = isQuiz ? 'fa-lightbulb' : 'fa-file-pdf';
                    const typeLabel = (item.Type && item.Type.includes('gt')) ? 'GT' : ((item.Type && item.Type.includes('pyq')) ? 'PYQ' : ((item.Type && item.Type.includes('btr')) ? 'BTR' : ''));

                    card.innerHTML = `
                    <div class="chapter-icon"><i class="fas ${icon}"></i></div>
                    <div style="flex-grow:1; font-weight:500;">
                        ${typeLabel ? `<span class="quiz-type-icon">[${typeLabel}]</span> ` : ''}
                        ${item.title}
                        <div style="margin-top:4px; display:flex; align-items:center; flex-wrap:wrap; gap:5px;">
                            ${item.Subject ? `<span class="subject-badge">${item.Subject}</span>` : ''}
                            ${item.platform ? `<span class="platform-badge">${item.platform}</span>` : ''}
                        </div>
                    </div>
                    ${item.isPremium ? '<div class="premium-lock"><i class="fas fa-lock"></i></div>' : '<i class="fas fa-external-link-alt" style="opacity:0.5;"></i>'}
                `;
                    container.appendChild(card);
                });

                if (items.length === 0) {
                    if (currentView === 'qbank') {
                        container.innerHTML = `
                        <div style="text-align:center; padding:3.5rem; color:var(--text-light)">
                            <i class="fas fa-exclamation-circle" style="font-size:3rem; opacity:0.1; margin-bottom:1.5rem;"></i>
                            <p style="font-weight:600;">No QBank files found for this subject.</p>
                            <p style="font-size:0.85rem; margin-top:0.5rem; color:#ef4444;">Please check if <b>Column B</b> in your sheet says "qbank".</p>
                            <p style="font-size:0.8rem; margin-top:1rem; opacity:0.7;">Subject: ${currentSubject} | Platform: ${currentPlatform}</p>
                        </div>
                    `;
                    } else {
                        container.innerHTML = `
                        <div style="text-align:center; padding:3.5rem; color:var(--text-light)">
                            <i class="fas fa-folder-open" style="font-size:3rem; opacity:0.1; margin-bottom:1.5rem;"></i>
                            <p style="font-weight:600;">No items found in this section.</p>
                            <p style="font-size:0.85rem; margin-top:0.5rem;">Please check the  <b>Premium</b> tab for more content!</p>
                        </div>
                    `;
                    }
                }
            }

            function renderVideoCard(container, video, index) {
                const card = document.createElement('div'); card.className = 'card';
                let vid = video.link;
                const uid = `yt-${index}`;
                card.innerHTML = `
                <div class="video-wrapper">
                    <div id="${uid}"></div>
                    <div class="glass-shield"></div>
                    <div class="tap-overlay" onclick="handleTap(event, '${uid}')">
                        <div class="tap-side" id="tap-left-${uid}"></div>
                        <div class="tap-side" id="tap-right-${uid}"></div>
                    </div>
                    <div id="seek-left-${uid}" class="seek-feedback seek-left"><i class="fas fa-backward"></i> -10s</div>
                    <div id="seek-right-${uid}" class="seek-feedback seek-right">+10s <i class="fas fa-forward"></i></div>
                </div>

                <!-- Moved outside wrapper for landscape flexibility -->
                <div class="custom-controls">
                    <div class="timeline-container">
                        <input type="range" class="timeline" id="seek-${uid}" min="0" value="0" oninput="userSeek('${uid}', this.value)">
                        <span class="time-display" id="time-${uid}">0:00 / 0:00</span>
                    </div>
                    <div class="buttons-row">
                        <button class="ctrl-btn primary" id="toggle-${uid}" onclick="togglePlayPause('${uid}')">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="ctrl-btn" onclick="seekBy(-10, '${uid}')">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="ctrl-btn" onclick="seekBy(10, '${uid}')">
                            <i class="fas fa-redo"></i>
                        </button>
                        <div class="speed-row" id="speed-row-${uid}">
                            <button class="speed-btn active" onclick="changeSpeed(1, '${uid}')">1x</button>
                            <button class="speed-btn" onclick="changeSpeed(1.5, '${uid}')">1.5x</button>
                            <button class="speed-btn" onclick="changeSpeed(2, '${uid}')">2x</button>
                        </div>
                        <button class="ctrl-btn" onclick="toggleFullScreen(this)">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                <div class="card-content"><div class="card-title">${video.title}</div></div>
            `;
                container.appendChild(card);
                if (window.YT && window.YT.Player) createPlayer(uid, vid); else pendingPlayers.push({ id: uid, vid: vid });
            }

            function addSectionHeader(container, text, icon) {
                const h = document.createElement('h3'); h.className = 'section-title';
                h.innerHTML = `<i class="fas ${icon}"></i> ${text}`; container.appendChild(h);
            }

            // --- ADVANCED VIDEO LOGIC ---
            let lastTapTime = 0;
            window.handleTap = (e, uid) => {
                const now = Date.now();
                const delay = now - lastTapTime;
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const width = rect.width;

                if (delay < 300) {
                    // Double Tap Detected
                    if (x < width * 0.4) {
                        seekBy(-10, uid);
                        showSeekFeedback('left', uid);
                    } else if (x > width * 0.6) {
                        seekBy(10, uid);
                        showSeekFeedback('right', uid);
                    }
                } else {
                    // Single Tap -> Pass to Toggle
                    togglePlayPause(uid);
                }
                lastTapTime = now;
            };

            window.togglePlayPause = (uid) => {
                const p = players[uid];
                if (p) {
                    const state = p.getPlayerState();
                    if (state === YT.PlayerState.PLAYING) p.pauseVideo();
                    else p.playVideo();
                }
            };

            function seekBy(seconds, uid) {
                const p = players[uid];
                if (p) {
                    const now = p.getCurrentTime();
                    p.seekTo(now + seconds, true);
                }
            }

            function showSeekFeedback(side, uid) {
                const el = document.getElementById(`seek-${side}-${uid}`);
                if (el) {
                    el.classList.add('active');
                    setTimeout(() => el.classList.remove('active'), 500);
                }
            }

            // ORIENTATION / FULLSCREEN OVERLAY
            window.activePlayerId = null;
            function updateOrientation() {
                const overlay = document.getElementById('landscapeOverlay');
                if (window.innerHeight < window.innerWidth && window.activePlayerId) {
                    overlay.classList.add('visible');
                    updateOverlaySpeedButtons();
                } else {
                    overlay.classList.remove('visible');
                }
            }
            window.addEventListener('resize', updateOrientation);
            window.addEventListener('orientationchange', updateOrientation);

            function updateOverlaySpeedButtons() {
                const container = document.getElementById('overlaySpeedRow');
                const currentSpeed = localStorage.getItem('preferred_speed') || 1;
                const speeds = [0.5, 1, 1.5, 2];

                container.innerHTML = speeds.map(s => `
                <button class="speed-btn ${parseFloat(currentSpeed) === s ? 'active' : ''}" 
                        onclick="changeSpeed(${s}, '${activePlayerId}')">
                    ${s === 1 ? 'Normal' : s + 'x'}
                </button>
            `).join('');
            }

            window.exitLandscape = () => {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
                document.getElementById('landscapeOverlay').classList.remove('visible');
            };

            // --- PLAYER ENGINE ---
            window.onYouTubeIframeAPIReady = () => { pendingPlayers.forEach(p => createPlayer(p.id, p.vid)); pendingPlayers = []; };
            function createPlayer(uid, vid) {
                const cleanVidId = getYoutubeVideoId(vid);
                console.log('Playing Video ID:', cleanVidId); // Debug log for browser console

                players[uid] = new YT.Player(uid, {
                    height: '100%', width: '100%', videoId: cleanVidId,
                    playerVars: { 'controls': 0, 'disablekb': 1, 'modestbranding': 1, 'rel': 0, 'playsinline': 1, 'origin': window.location.origin },
                    events: { 'onReady': (e) => onReady(e, uid), 'onStateChange': (e) => onStateChange(e, uid) }
                });
            }
            function onReady(e, uid) {
                const dur = e.target.getDuration();
                document.getElementById(`seek-${uid}`).max = dur;
                updateClock(uid, 0, dur);

                // RESUME LOGIC
                const vidData = e.target.getVideoData();
                const videoId = vidData.video_id;
                const savedTime = localStorage.getItem('resume_' + videoId);
                if (savedTime) {
                    e.target.seekTo(parseFloat(savedTime), true);
                }

                // APPLY PREFERRED SPEED
                const preferredSpeed = localStorage.getItem('preferred_speed') || 1;
                changeSpeed(parseFloat(preferredSpeed), uid);
            }
            function onStateChange(e, uid) {
                const vidData = e.target.getVideoData();
                const videoId = vidData.video_id;

                if (e.data == YT.PlayerState.PLAYING) {
                    window.activePlayerId = uid;
                    updateOrientation();
                    updatePlayPauseIcon(uid, true);
                    e.target.setPlaybackQuality('hd720');
                    if (players[uid].timer) clearInterval(players[uid].timer);
                    players[uid].timer = setInterval(() => {
                        const t = e.target.getCurrentTime();
                        const d = e.target.getDuration();
                        document.getElementById(`seek-${uid}`).value = t;
                        updateClock(uid, t, d);

                        // SAVE PROGRESS
                        localStorage.setItem('resume_' + videoId, t);

                        // TRACK COMPLETION (90%)
                        if (d > 0 && t > (d * 0.9)) {
                            localStorage.setItem('completed_' + videoId, 'true');
                        }
                    }, 1000);
                } else {
                    clearInterval(players[uid].timer);
                    updatePlayPauseIcon(uid, false);
                }
            }

            function updatePlayPauseIcon(uid, isPlaying) {
                const btn = document.getElementById(`toggle-${uid}`);
                if (btn) {
                    btn.innerHTML = `<i class="fas ${isPlaying ? 'fa-pause' : 'fa-play'}"></i>`;
                }
            }
            function updateClock(uid, curr, dur) { document.getElementById(`time-${uid}`).innerText = `${fmt(curr)} / ${fmt(dur)}`; }
            function fmt(s) { const m = Math.floor(s / 60); const sc = Math.floor(s % 60); return `${m}:${sc < 10 ? '0' : ''}${sc}`; }

            window.controlPlayer = (uid, a) => players[uid][a + 'Video']();
            window.userSeek = (uid, v) => players[uid].seekTo(v, true);

            window.changeSpeed = (rate, uid) => {
                if (players[uid] && players[uid].setPlaybackRate) {
                    players[uid].setPlaybackRate(rate);
                    // Persistence
                    localStorage.setItem('preferred_speed', rate);
                    // UI Update Primary
                    const row = document.getElementById(`speed-row-${uid}`);
                    if (row) {
                        row.querySelectorAll('.speed-btn').forEach(btn => {
                            btn.classList.toggle('active', parseFloat(btn.innerText) === rate || (rate === 1 && btn.innerText === 'Normal'));
                        });
                    }
                    // UI Update Overlay
                    updateOverlaySpeedButtons();
                }
            };

            window.openQuiz = (url) => {
                pushNavState(); // Save list state before opening modal
                const viewer = document.getElementById('fileViewer');
                const loader = document.getElementById('pdfLoader');
                const externalBtn = document.getElementById('externalLink');

                viewer.removeAttribute('srcdoc');
                viewer.src = "about:blank";
                loader.style.display = 'block';

                const formattedUrl = formatDriveLink(url);
                viewer.src = formattedUrl;
                if (externalBtn) externalBtn.href = url;

                document.getElementById('fileModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
            };

            window.toggleFullScreen = (btn) => {
                const c = btn.closest('.card');
                if (!document.fullscreenElement) {
                    c.requestFullscreen().then(updateOrientation).catch(e => console.error(e));
                } else {
                    document.exitFullscreen();
                }
            };

            // --- FILE ENGINE ---
            function formatDriveLink(url) {
                if (!url || !url.includes('drive.google.com')) return url;
                const match = url.match(/\/d\/([^\/?#]+)|id=([^\/&#?]+)/);
                const id = (match && (match[1] || match[2])) ? (match[1] || match[2]) : "";
                return id ? `https://drive.google.com/file/d/${id}/preview` : url;
            }

            window.openFile = (urlOrContent) => {
                pushNavState(); // Save list state before opening modal
                const viewer = document.getElementById('fileViewer');
                const loader = document.getElementById('pdfLoader');
                const externalBtn = document.getElementById('externalLink');

                viewer.removeAttribute('srcdoc');
                viewer.src = "about:blank";
                loader.style.display = 'block';

                if (urlOrContent.startsWith('http')) {
                    const formatted = formatDriveLink(urlOrContent);
                    viewer.src = formatted;
                    if (externalBtn) externalBtn.href = urlOrContent;
                } else {
                    viewer.srcdoc = urlOrContent;
                    if (externalBtn) externalBtn.style.display = 'none';
                }

                document.getElementById('fileModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
            };

            window.togglePdfFullScreen = () => {
                const f = document.getElementById('fileModal');
                if (!document.fullscreenElement) f.requestFullscreen();
                else document.exitFullscreen();
            };

            window.closeModal = () => {
                // Close via goBack to restore previous list state and scroll Position
                if (navHistory.length > 0) {
                    goBack();
                } else {
                    cleanupIframes();
                    document.getElementById('fileModal').style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            };
        </script>
</body>

</html>